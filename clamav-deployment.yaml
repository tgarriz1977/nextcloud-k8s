## ============================================================================
## PERSISTENT VOLUME CLAIM - Para la base de datos de virus
## ============================================================================

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: clamav-pvc
  namespace: nextcloud
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: gp2  # EBS en AWS
  resources:
    requests:
      storage: 10Gi  # Espacio para base de datos de firmas de virus

---
## ============================================================================
## CONFIGMAP - Configuración de ClamAV
## ============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: clamav-config
  namespace: nextcloud
data:
  clamd.conf: |
    ###############
    # General
    ###############
    
    DatabaseDirectory /var/lib/clamav
    TemporaryDirectory /tmp
    LogTime yes
    LogClean no
    LogSyslog no
    LogFacility LOG_LOCAL6
    LogVerbose no
    LogRotate yes
    
    PidFile /run/clamav/clamd.pid
    LocalSocket /run/clamav/clamd.sock
    TCPSocket 3310
    TCPAddr 0.0.0.0
    
    ###############
    # Scanning
    ###############
    
    MaxScanSize 100M
    MaxFileSize 100M
    MaxRecursion 16
    MaxFiles 10000
    MaxEmbeddedPE 10M
    MaxHTMLNormalize 10M
    MaxHTMLNoTags 2M
    MaxScriptNormalize 5M
    MaxZipTypeRcg 1M
    
    ###############
    # Streaming
    ###############
    
    StreamMaxLength 100M
    
    ###############
    # Alerting
    ###############
    
    AlertBrokenExecutables yes
    AlertEncrypted no
    AlertEncryptedArchive no
    AlertEncryptedDoc no
    AlertOLE2Macros yes
    AlertPhishingSSLMismatch no
    AlertPhishingCloak no
    AlertPartitionIntersection no
    
    ###############
    # Performance
    ###############
    
    ScanPE yes
    ScanELF yes
    ScanOLE2 yes
    ScanPDF yes
    ScanSWF yes
    ScanMail yes
    ScanPartialMessages yes
    ScanArchive yes
    
    # Heuristics
    HeuristicScanPrecedence yes
    StructuredDataDetection yes
    
    # Signatures
    DetectPUA yes
    ExcludePUA NetTool
    ExcludePUA PWTool
    AlgorithmicDetection yes
    Bytecode yes
    
    ###############
    # Limits
    ###############
    
    MaxThreads 4
    ReadTimeout 300
    CommandReadTimeout 30
    SendBufTimeout 500
    MaxQueue 200
    IdleTimeout 60
    ExcludeUser clamav
    
    # User friendliness
    Foreground yes
    
  freshclam.conf: |
    ###############
    # General
    ###############
    
    DatabaseDirectory /var/lib/clamav
    UpdateLogFile /var/log/clamav/freshclam.log
    LogTime yes
    LogRotate yes
    LogSyslog no
    LogVerbose no
    
    PidFile /run/clamav/freshclam.pid
    
    ###############
    # Updates
    ###############
    
    DatabaseOwner clamav
    DatabaseMirror database.clamav.net
    
    # Número de checks por día (24 = cada hora)
    Checks 24
    
    # Configuración de red
    ConnectTimeout 30
    ReceiveTimeout 60
    TestDatabases yes
    
    # Compresión
    CompressLocalDatabase no

---
## ============================================================================
## DEPLOYMENT DE CLAMAV
## ============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: clamav
  namespace: nextcloud
  labels:
    app: clamav
spec:
  replicas: 1  # 1 réplica es suficiente para 80 usuarios
  selector:
    matchLabels:
      app: clamav
  strategy:
    type: Recreate  # No puede tener múltiples réplicas con RWO PVC
  template:
    metadata:
      labels:
        app: clamav
    spec:
      initContainers:
      ## Init container para descargar base de datos inicial
      - name: clamav-init
        image: clamav/clamav:latest
        command:
        - sh
        - -c
        - |
          echo "Iniciando descarga de base de datos de virus..."
          freshclam --config-file=/etc/clamav/freshclam.conf --foreground --stdout
          echo "Base de datos de virus descargada exitosamente"
        volumeMounts:
        - name: clamav-data
          mountPath: /var/lib/clamav
        - name: clamav-config
          mountPath: /etc/clamav
      
      containers:
      - name: clamav
        image: clamav/clamav:latest
        imagePullPolicy: Always
        
        ## Recursos
        resources:
          requests:
            cpu: 500m
            memory: 2Gi  # ClamAV necesita bastante RAM
          limits:
            cpu: 2000m
            memory: 4Gi
        
        ## Puertos
        ports:
        - name: clamav
          containerPort: 3310
          protocol: TCP
        
        ## Volúmenes
        volumeMounts:
        - name: clamav-data
          mountPath: /var/lib/clamav
        - name: clamav-config
          mountPath: /etc/clamav
        - name: clamav-logs
          mountPath: /var/log/clamav
        
        ## Health checks
        livenessProbe:
          tcpSocket:
            port: 3310
          initialDelaySeconds: 180  # ClamAV tarda en iniciar
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          tcpSocket:
            port: 3310
          initialDelaySeconds: 120
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        ## Variables de entorno
        env:
        - name: CLAMD_STARTUP_TIMEOUT
          value: "300"
        - name: FRESHCLAM_CHECKS
          value: "24"  # Actualizar cada hora
      
      ## Contenedor sidecar para actualización automática de base de datos
      - name: freshclam
        image: clamav/clamav:latest
        command:
        - freshclam
        - --daemon
        - --config-file=/etc/clamav/freshclam.conf
        - --foreground
        - --stdout
        
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        volumeMounts:
        - name: clamav-data
          mountPath: /var/lib/clamav
        - name: clamav-config
          mountPath: /etc/clamav
        - name: clamav-logs
          mountPath: /var/log/clamav
      
      ## Volúmenes
      volumes:
      - name: clamav-data
        persistentVolumeClaim:
          claimName: clamav-pvc
      - name: clamav-config
        configMap:
          name: clamav-config
      - name: clamav-logs
        emptyDir: {}

---
## ============================================================================
## SERVICE PARA CLAMAV
## ============================================================================

apiVersion: v1
kind: Service
metadata:
  name: clamav-service
  namespace: nextcloud
  labels:
    app: clamav
spec:
  type: ClusterIP
  ports:
  - name: clamav
    port: 3310
    targetPort: 3310
    protocol: TCP
  selector:
    app: clamav

---
## ============================================================================
## POD DISRUPTION BUDGET (Opcional - Para alta disponibilidad)
## ============================================================================

apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: clamav-pdb
  namespace: nextcloud
spec:
  minAvailable: 0  # Permite interrupciones ya que solo hay 1 réplica
  selector:
    matchLabels:
      app: clamav
